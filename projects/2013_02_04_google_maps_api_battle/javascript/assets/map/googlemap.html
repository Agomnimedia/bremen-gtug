<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="styles.css" />
<script type="text/javascript"
	src="http://maps.googleapis.com/maps/api/js?sensor=true">
	
</script>
<script type="text/javascript">
	/**
	 * Reference to the GoogleMaps element.
	 */
	var map;

	/**
	 * An object for using googles Geocoder API.
	 */
	var geocoder = new google.maps.Geocoder();

	/**
	 * Stores the all informations of the landmarks.
	 */
	var landmarks;

	/**
	 * Stores the last opened info window.
	 */
	var lastInfoWindow;

	/**
	 * Stores the marker for the current geolocation of the user.
	 */
	var currentPositionMarker = new google.maps.Circle({
		clickable : false,
		radius : 0.2,
		strokeColor : '#0066FF',
		strokeOpacity : 1,
		strokeWeight : 10
	});

	/**
	 * Stores the circle around the marker for the current geolocation of the user.
	 */
	var currentPositionMarkerCircle = new google.maps.Circle({
		clickable : false,
		fillColor : '#0099FF',
		fillOpacity : 0.15,
		strokeColor : '#0099FF',
		strokeOpacity : 0.5,
		strokeWeight : 1
	});

	/**
	 * Stores the ground overlay with an historical map.
	 */
	var historicalGroundOverlay = new google.maps.GroundOverlay(
			"img/historisch.png", new google.maps.LatLngBounds(
					new google.maps.LatLng(53.072559, 8.806052), // southwest
					new google.maps.LatLng(53.077416, 8.813648) // northeast
			));
	historicalGroundOverlay.setOpacity(0.7);

	/**
	 * Control button to jump to the current geo location.
	 */
	var controlUI;

	/**
	 * id of the geolocation watching process, for aborting on page unload.
	 */
	var watchGeolocationId;

	function initialize() {
		var mapOptions = {
			center : new google.maps.LatLng(53.075858, 8.80772),
			zoom : 17,
			mapTypeId : google.maps.MapTypeId.HYBRID, //TERRAIN, HYBRID, ROADMAP, SATELLITE
			panControl : false,
			zoomControl : false,
			mapTypeControl : false,
			scaleControl : false,
			streetViewControl : false,
			overviewMapControl : false
		};
		map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);

		// Setup the click event listener on the control UI.
		controlUI = document.getElementById("controlUI");
		google.maps.event.addDomListener(controlUI, 'click', function() {
			map.setCenter(currentPositionMarker.getCenter());
		});

		// We don't really need to set an index value here, but
		// this would be how you do it. Note that we set this
		// value as a property of the DIV itself.
		document.getElementById("controlDiv").index = 1;

		//Add the control to the map at a designated control position
		//by pushing it on the position's array. This code will
		//implicitly add the control to the DOM, through the Map
		//object. You should not attach the control manually.
		map.controls[google.maps.ControlPosition.TOP_RIGHT].push(document
				.getElementById("controlDiv"));
	}

	function showMarker() {
		console.debug("showMarker()");
		var i;
		if (landmarks == null) {
			// interact with the Android-JavaScript-Interface to get the informtions of all landmarks.
			landmarks = JSON.parse(androidapp.getLandmarks());
			console.debug("showMarker() revceived all landmarks from xml-file.");
			(function() {
				androidapp.startGeocoderSearching(landmarks.length);
			})();
			for (i = 0; i < landmarks.length; i++) {
				geocode(i);
			}
		} else {
			for (i = 0; i < landmarks.length; i++) {
				landmarks[i].marker.setVisible(true);
			}
		}
	}

	function hideMarker() {
		console.debug("hideMarker()");
		for ( var i = 0; i < landmarks.length; i++) {
			landmarks[i].marker.setVisible(false);
		}
	}

	function showOverlays() {
		console.debug("showOverlays()");
		historicalGroundOverlay.setMap(map);
	}

	function hideOverlays() {
		console.debug("hideOverlays()");
		historicalGroundOverlay.setMap(null);
	}

	function showPosition() {
		console.debug("showPosition()");
		watchGeolocationId = navigator.geolocation.watchPosition(
				function(position) {
					console.debug("geolocation details: "
							+ JSON.stringify(position.coords));
					updateGeoPosition(position.coords.latitude,
							position.coords.longitude, position.coords.accuracy);
				}, function(error) {
					console.error("There are no current geoposition, because '"
							+ error.message + "', Code " + error.code);
				}, {
					maximumAge : 3000,
					timeout : 5000,
					enableHighAccuracy : true
				});
	}

	function hidePosition() {
		console.debug("hidePosition()");
		if (watchGeolocationId) {
			navigator.geolocation.clearWatch(watchGeolocationId);
		}
		controlUI.style.display = 'none';
		currentPositionMarker.setMap(null);
		currentPositionMarkerCircle.setMap(null);
	}

	function setMapType(mapType) {
		console.debug("setMapType(" + mapType + ")");
		if (mapType == "NONE") {
			map.setMapTypeId();
		} else {
			map.setMapTypeId(google.maps.MapTypeId[mapType]);
		}
	}

	function showLandmarkOnMap(landmarksIndex) {
		landmarks[landmarksIndex].marker = new google.maps.Marker({
			position : landmarks[landmarksIndex].latlng,
			map : map,
			title : landmarks[landmarksIndex].name
		});
		var addInfo = '';
		if (landmarks[landmarksIndex].additionalInformation) {
			if (landmarks[landmarksIndex].additionalInformation.beschreibung) {
				addInfo += '<p>'
						+ landmarks[landmarksIndex].additionalInformation.beschreibung
						+ '</p>';
			}
			if (landmarks[landmarksIndex].additionalInformation.homepage) {
				if (landmarks[landmarksIndex].additionalInformation.homepage.substr(0,
						4) != 'http') {
					landmarks[landmarksIndex].additionalInformation.homepage = 'http://'
							+ landmarks[landmarksIndex].additionalInformation.homepage
				}
				addInfo += '<h2>Webseite:</h2><p><a href="'
						+ landmarks[landmarksIndex].additionalInformation.homepage + '">'
						+ landmarks[landmarksIndex].additionalInformation.homepage
						+ '</a></p>';
			}
			if (landmarks[landmarksIndex].additionalInformation.oeffnungszeiten) {
				addInfo += '<h2>&Ouml;ffnungszeiten:</h2><p>'
						+ landmarks[landmarksIndex].additionalInformation.oeffnungszeiten
						+ '</p>';
			}
		}
		landmarks[landmarksIndex].infowindow = new google.maps.InfoWindow({
			content : '<h1>' + landmarks[landmarksIndex].name + '</h1><p>'
					+ landmarks[landmarksIndex].address + '</p>' + addInfo
		});
		google.maps.event.addListener(landmarks[landmarksIndex].marker, 'click',
				function() {
					if (lastInfoWindow != null) {
						lastInfoWindow.close();
					}
					landmarks[landmarksIndex].infowindow.open(map,
							landmarks[landmarksIndex].marker);
					lastInfoWindow = landmarks[landmarksIndex].infowindow;
				});
	}

	function geocode(landmarksIndex) {
		if (landmarks[landmarksIndex].address
				.substr(landmarks[landmarksIndex].address.length - 2) == " 0") {
			landmarks[landmarksIndex].address = landmarks[landmarksIndex].address
					.substr(0, landmarks[landmarksIndex].address.length - 2);
		}
		geocoder.geocode({
			address : landmarks[landmarksIndex].address + ", Bremen",
			//bounds : LatLngBounds, // to prefer serching in this bounds
			region : 'DE' // prefer searching in this country/region
		}, function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				landmarks[landmarksIndex].latlng = results[0].geometry.location;
				console.debug(landmarks[landmarksIndex].address + " -> "
						+ results[0].geometry.location.lat() + ", "
						+ results[0].geometry.location.lng());
				androidapp.setGeocoderSearchingState(1);
				showLandmarkOnMap(landmarksIndex);
			} else if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
				// sometimes the API returns this state, but try again the request solves this problem ;) 
				setTimeout(function() {
					geocode(landmarksIndex);
				}, 200);
			} else {
				androidapp.setGeocoderSearchingState(1);
				console.error("Geocode of '" + landmarks[landmarksIndex].address
						+ "' was not successful for the following reason: " + status);
			}
		});
	}

	/**
	 * update the circle position and size on the current users geo location.
	 * 
	 * @param {Number}
	 *          latitude the latitude of the geo location.
	 * @param {Number}
	 *          longitude the longitude of the geo location.
	 * @param {Number}
	 *          accuracy of the geo location.
	 */
	var updateGeoPosition = function(latitude, longitude, accuracy) {
		currentPositionMarker.setMap(null);
		currentPositionMarkerCircle.setMap(null);
		var markerLatlng = new google.maps.LatLng(latitude, longitude);
		currentPositionMarker.setCenter(markerLatlng);
		currentPositionMarkerCircle.setCenter(markerLatlng);
		currentPositionMarkerCircle.setRadius(accuracy);
		currentPositionMarker.setMap(map);
		currentPositionMarkerCircle.setMap(map);
		controlUI.style.display = 'block';
	}
</script>
</head>
<body onload="initialize()">
	<div id="map_canvas"></div>

	<div style="display: none;">
		<!-- HTML elements for using during JavaScript execution, to reduce the costs of creating elements programmatically. -->

		<div id="controlDiv">
			<div id="controlUI">
				<div class="mylocation">&nbsp;</div>
			</div>
		</div>

	</div>
</body>
</html>